#!/bin/bash
set -e

# 1. Clonar a branch main do repositório em /opt/
cd /opt/
git clone -b main https://github.com/carlos-cabgj/cloudunderroof.git cloudunderroof

apt-get update
apt-get install -y apache2 apache2-dev

# Instalar PostgreSQL
sudo apt install -y libpq-dev postgresql postgresql-contrib
sudo apt-get install -y libapache2-mod-wsgi-py3


# 2. Criar venv no projeto
cd /opt/cloudunderroof/app
python3 -m venv venv

# 3. Ativar venv
source venv/bin/activate

# 4. Instalar pacotes do requirements.txt
pip install --upgrade pip
pip install -r /opt/cloudunderroof/infra/requirements.txt


#!/bin/bash
set -e


# Garantir que o serviço esteja rodando
sudo systemctl enable postgresql
sudo systemctl start postgresql

# Criar usuário e banco de dados
sudo -u postgres psql <<EOF
-- Criar usuário com senha
CREATE USER cloudUser WITH PASSWORD 'passToChange';

-- Criar banco de dados associado ao usuário
CREATE DATABASE cloudDB OWNER cloudUser;

-- Garantir privilégios
GRANT ALL PRIVILEGES ON DATABASE cloudDB TO cloudUser;
EOF

echo "PostgreSQL 15 instalado, usuário 'cloudUser' criado e banco 'cloudDB' configurado com sucesso!"

sudo mkdir -p /etc/apache2/ssl

sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
 -keyout /etc/apache2/ssl/cloudunderroof.key \
 -out /etc/apache2/ssl/cloudunderroof.crt \
 -subj "/C=BR/ST=State/L=City/O=CloudUnderRoof/CN=192.168.0.42"

#!/bin/bash
set -e

# Caminho base do projeto
APP_DIR="/opt/cloudunderroof/app"

# Arquivo de origem e destino
SOURCE_FILE="$APP_DIR/.env_template"
DEST_FILE="$APP_DIR/.env"

# Copiar o arquivo
cp "$SOURCE_FILE" "$DEST_FILE"

echo "Arquivo .env criado a partir de .env_template em $APP_DIR"


# 5. Copiar arquivo para sites-available do Apache
sudo cp /opt/cloudunderroof/infra/config_apache.txt /etc/apache2/sites-available/cloudunderroof.conf

# 6. Substituir termos no arquivo de configuração do Apache
sed -i 's#/tcc-engs/app#/opt/cloudunderroof/app#g' /etc/apache2/sites-available/cloudunderroof.conf


# 7. Habilitar o site no Apache
sudo a2ensite cloudunderroof.conf

sudo a2dissite 000-default.conf
sudo a2dissite default-ssl.conf

sudo rm /etc/apache2/sites-available/000-default.conf
sudo rm /etc/apache2/sites-available/default-ssl.conf

# 8. Reiniciar o Apache
sudo a2enmod rewrite
sudo a2enmod ssl
sudo a2enmod headers
sudo a2enmod wsgi

sudo systemctl restart apache2

echo "Deploy concluído com sucesso!"
